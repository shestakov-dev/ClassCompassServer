generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

enum LessonWeek {
    odd
    even
    every
}

enum Day {
    monday
    tuesday
    wednesday
    thursday
    friday
    saturday
    sunday
}

// TODO: Add more fields for things like ip address, user agent, etc.
model Session {
    id           String   @id @default(uuid())
    refreshToken String   @unique
    expiresAt    DateTime

    userId String
    user   User   @relation(fields: [userId], references: [id])

    createdAt DateTime  @default(now())
    updatedAt DateTime  @updatedAt
    deleted   Boolean   @default(false)
    deletedAt DateTime?

    @@index([userId])
}

model Role {
    id         String   @id @default(uuid())
    name       String   @unique
    attributes String[] @default([])

    schoolId String
    school   School @relation(fields: [schoolId], references: [id])

    users User[]

    createdAt DateTime  @default(now())
    updatedAt DateTime  @updatedAt
    deleted   Boolean   @default(false)
    deletedAt DateTime?

    // The role name should be unique within a school
    @@unique([schoolId, name])
    @@index([schoolId])
}

model User {
    id       String @id @default(uuid())
    name     String
    email    String @unique
    password String

    schoolId String
    school   School @relation(fields: [schoolId], references: [id])

    teacher Teacher?
    student Student?

    roles Role[]

    sessions Session[]

    createdAt DateTime  @default(now())
    updatedAt DateTime  @updatedAt
    deleted   Boolean   @default(false)
    deletedAt DateTime?

    @@index([schoolId])
}

model School {
    id   String @id @default(uuid())
    name String @unique

    users User[]

    classes Class[]

    roles Role[]

    buildings Building[]

    subjects Subject[]

    createdAt DateTime  @default(now())
    updatedAt DateTime  @updatedAt
    deleted   Boolean   @default(false)
    deletedAt DateTime?
}

model Building {
    id   String @id @default(uuid())
    name String

    schoolId String
    school   School @relation(fields: [schoolId], references: [id])

    floors Floor[]

    createdAt DateTime  @default(now())
    updatedAt DateTime  @updatedAt
    deleted   Boolean   @default(false)
    deletedAt DateTime?

    // The building name should be unique within a school
    @@unique([schoolId, name])
    @@index([schoolId])
}

model Floor {
    id          String  @id @default(uuid())
    number      Int
    description String?

    buildingId String
    building   Building @relation(fields: [buildingId], references: [id])

    rooms Room[]

    createdAt DateTime  @default(now())
    updatedAt DateTime  @updatedAt
    deleted   Boolean   @default(false)
    deletedAt DateTime?

    // The floor number should be unique within a building
    @@unique([buildingId, number])
    @@index([buildingId])
}

model Room {
    id   String @id @default(uuid())
    name String

    floorId String
    floor   Floor  @relation(fields: [floorId], references: [id])

    lessons Lesson[]

    createdAt DateTime  @default(now())
    updatedAt DateTime  @updatedAt
    deleted   Boolean   @default(false)
    deletedAt DateTime?

    // The room name should be unique within a floor
    @@unique([floorId, name])
    @@index([floorId])
}

model Teacher {
    id String @id @default(uuid())

    userId String @unique
    user   User   @relation(fields: [userId], references: [id])

    subjects Subject[]

    lessons Lesson[]

    createdAt DateTime  @default(now())
    updatedAt DateTime  @updatedAt
    deleted   Boolean   @default(false)
    deletedAt DateTime?
}

model Subject {
    id   String @id @default(uuid())
    name String

    schoolId String
    school   School @relation(fields: [schoolId], references: [id])

    teachers Teacher[]

    lessons Lesson[]

    createdAt DateTime  @default(now())
    updatedAt DateTime  @updatedAt
    deleted   Boolean   @default(false)
    deletedAt DateTime?

    // The subject name should be unique within a school
    @@unique([schoolId, name])
    @@index([schoolId])
}

model Class {
    id   String @id @default(uuid())
    name String

    schoolId String
    school   School @relation(fields: [schoolId], references: [id])

    students Student[]

    weeklySchedule DailySchedule[]

    createdAt DateTime  @default(now())
    updatedAt DateTime  @updatedAt
    deleted   Boolean   @default(false)
    deletedAt DateTime?

    // The class name should be unique within a school
    @@unique([schoolId, name])
    @@index([schoolId])
}

model Student {
    id String @id @default(uuid())

    userId String @unique
    user   User   @relation(fields: [userId], references: [id])

    classId String
    class   Class  @relation(fields: [classId], references: [id])

    createdAt DateTime  @default(now())
    updatedAt DateTime  @updatedAt
    deleted   Boolean   @default(false)
    deletedAt DateTime?

    @@index([classId])
}

model DailySchedule {
    id  String @id @default(uuid())
    day Day

    classId String
    class   Class  @relation(fields: [classId], references: [id])

    lessons Lesson[]

    createdAt DateTime  @default(now())
    updatedAt DateTime  @updatedAt
    deleted   Boolean   @default(false)
    deletedAt DateTime?

    @@unique([classId, day])
    @@index([classId])
    @@index([day])
}

model Lesson {
    id           String     @id @default(uuid())
    lessonNumber Int
    startTime    DateTime
    endTime      DateTime
    lessonWeek   LessonWeek @default(every)

    roomId String
    room   Room   @relation(fields: [roomId], references: [id])

    teacherId String
    teacher   Teacher @relation(fields: [teacherId], references: [id])

    subjectId String
    subject   Subject @relation(fields: [subjectId], references: [id])

    dailyScheduleId String
    dailySchedule   DailySchedule @relation(fields: [dailyScheduleId], references: [id])

    createdAt DateTime  @default(now())
    updatedAt DateTime  @updatedAt
    deleted   Boolean   @default(false)
    deletedAt DateTime?

    // The lesson number should be unique within a daily schedule and week type
    @@unique([lessonNumber, lessonWeek, dailyScheduleId])
    @@index([roomId])
    @@index([teacherId])
    @@index([subjectId])
    @@index([dailyScheduleId])
}
